<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Institutional Market State Engine</title>

<!-- CACHE KILL (GitHub Pages fix) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
:root{
  --bg:#071226;
  --card:#0f2030;
  --border:#152433;
  --text:#e6f0fb;
  --muted:#9fb0c8;
  --accent:#00d084;
  --danger:#ff6b6b;
}
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:1200px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
select,button{
  background:#071b2b;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px 10px;
}
button{cursor:pointer}
.state{
  font-size:20px;
  font-weight:700;
  margin-top:6px;
}
.level{
  padding:8px;
  background:rgba(255,255,255,0.03);
  border-radius:8px;
  margin-bottom:6px;
}
.stop{color:var(--danger);font-size:13px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

<div class="card header">
  <div>
    <div style="font-size:20px;font-weight:600">Institutional Market State</div>
    <div class="small">Execution • Stops • State logic (1H)</div>
  </div>
  <div>
    <select id="symbol"></select>
    <button id="connect">Connect</button>
    <span id="status" class="small">Disconnected</span>
  </div>
</div>

<div class="card">
  <div class="small">Current Price</div>
  <div id="price" style="font-size:26px;font-weight:700">—</div>
  <div class="state" id="state">—</div>
</div>

<div class="card">
  <div class="small">Major Execution Clusters & Stop Zones</div>
  <div id="levels" style="margin-top:10px">Waiting…</div>
</div>

</div>

<script>
/* ==============================
   STATE ENGINE
============================== */
const STATE={
  ACCUMULATION:'ACCUMULATION',
  EXECUTION:'EXECUTION',
  DISTRIBUTION:'DISTRIBUTION',
  RESET:'RESET'
};

let clusters=new Map();
let priceHistory=[];
let deltaHistory=[];
let liquidityHistory=[];
let lastPrice=null;
let currentState=STATE.RESET;
let ws=null;

function avg(a){return a.reduce((x,y)=>x+y,0)/a.length||0}

function updateState(){
  const vol=Math.max(...priceHistory)-Math.min(...priceHistory);
  const delta=avg(deltaHistory);
  const liq=avg(liquidityHistory);

  if(vol<liq*0.15 && Math.abs(delta)<liq*0.1) currentState=STATE.ACCUMULATION;
  else if(Math.abs(delta)>liq*0.6) currentState=STATE.EXECUTION;
  else if(vol>liq*0.4 && Math.abs(delta)<liq*0.2) currentState=STATE.DISTRIBUTION;
  else if(vol<liq*0.08) currentState=STATE.RESET;

  document.getElementById('state').innerText=currentState;
}

/* ==============================
   CLUSTER & STOP LOGIC
============================== */
function binSize(p){return p>=1000?100:p*0.01}

function addTrade(price,qty,side){
  const b=binSize(price);
  const key=Math.round(price/b)*b;
  if(!clusters.has(key)) clusters.set(key,{price:key,vol:0,buy:0,sell:0});
  const c=clusters.get(key);
  c.vol+=qty;
  side==='buy'?c.buy+=qty:c.sell+=qty;
}

function majorClusters(){
  const arr=[...clusters.values()];
  if(arr.length<5) return [];
  const a=avg(arr.map(x=>x.vol));
  return arr.filter(x=>x.vol>a*1.8).sort((a,b)=>b.vol-a.vol).slice(0,6);
}

function stopZones(c){
  const range=binSize(c.price)*2;
  if(c.sell>c.buy*1.5){
    return {type:'BUY STOPS',from:c.price+range,to:c.price+range*1.5};
  }
  if(c.buy>c.sell*1.5){
    return {type:'SELL STOPS',from:c.price-range*1.5,to:c.price-range};
  }
  return null;
}

/* ==============================
   RENDER
============================== */
function render(){
  if(!lastPrice) return;
  document.getElementById('price').innerText=lastPrice.toFixed(2);
  updateState();

  const el=document.getElementById('levels');
  const majors=majorClusters();
  if(!majors.length){el.innerHTML='Building…';return;}

  el.innerHTML=majors.map(c=>{
    const s=stopZones(c);
    return `
      <div class="level">
        <b>${c.price.toFixed(2)}</b> — Vol ${c.vol.toFixed(0)}
        ${s?`<div class="stop">${s.type}: ${s.from.toFixed(2)} → ${s.to.toFixed(2)}</div>`:''}
      </div>`;
  }).join('');
}

/* ==============================
   BINANCE DATA
============================== */
async function loadSymbols(){
  const r=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
  const d=await r.json();
  document.getElementById('symbol').innerHTML=
    d.symbols.filter(s=>s.contractType==='PERPETUAL')
    .map(s=>`<option>${s.symbol}</option>`).join('');
}

document.getElementById('connect').onclick=()=>{
  if(ws) ws.close();
  clusters.clear();
  priceHistory=[];
  deltaHistory=[];
  liquidityHistory=[];
  const sym=document.getElementById('symbol').value.toLowerCase();
  ws=new WebSocket(`wss://fstream.binance.com/ws/${sym}@aggTrade`);
  ws.onopen=()=>status.innerText='Connected';
  ws.onmessage=e=>{
    const t=JSON.parse(e.data);
    const p=+t.p,q=+t.q,side=t.m?'sell':'buy';
    lastPrice=p;
    addTrade(p,q,side);
    priceHistory.push(p);
    deltaHistory.push(side==='buy'?q:-q);
    if(priceHistory.length>60){priceHistory.shift();deltaHistory.shift();}
    render();
  };
};

loadSymbols();
</script>
</body>
</html>
