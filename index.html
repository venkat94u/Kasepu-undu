<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Institutional Stop-Loss Map</title>

<!-- Cache kill (GitHub Pages fix) -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
:root{
  --bg:#071226;
  --card:#0f2030;
  --border:#152433;
  --text:#e6f0fb;
  --muted:#9fb0c8;
  --buy:#00d084;
  --sell:#ff6b6b;
}
body{
  margin:0;
  font-family:Inter,system-ui,Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:1100px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  margin-bottom:14px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
select,button{
  background:#071b2b;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px 10px;
}
button{cursor:pointer}
.price{
  font-size:28px;
  font-weight:700;
}
.zone{
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
}
.buyZone{background:rgba(0,208,132,0.08);border:1px solid rgba(0,208,132,0.35)}
.sellZone{background:rgba(255,107,107,0.08);border:1px solid rgba(255,107,107,0.35)}
.small{font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

<div class="card header">
  <div>
    <div style="font-size:20px;font-weight:600">Institutional Stop-Loss Levels</div>
    <div class="small">Only high-confidence â€¢ Executed-volume derived</div>
  </div>
  <div>
    <select id="symbol"></select>
    <button id="connect">Connect</button>
    <span id="status" class="small">Disconnected</span>
  </div>
</div>

<div class="card">
  <div class="small">Current Price</div>
  <div id="price" class="price">â€”</div>
</div>

<div class="card">
  <div class="small">BUY STOP ZONES (Above Price)</div>
  <div id="buyStops">Buildingâ€¦</div>
</div>

<div class="card">
  <div class="small">SELL STOP ZONES (Below Price)</div>
  <div id="sellStops">Buildingâ€¦</div>
</div>

</div>

<script>
/* ===============================
   CORE DATA STRUCTURES
================================ */
let ws=null;
let lastPrice=null;
let tradeBuffer=[];
let hourBuckets=new Map();
let finalizedZones={ buy:[], sell:[] };

/* ===============================
   HELPERS
================================ */
function avg(a){return a.reduce((x,y)=>x+y,0)/a.length||0}
function binSize(p){return p>=1000?100:p*0.01}

/* ===============================
   EXECUTION BUCKET (1H)
================================ */
function addTrade(price,qty,side){
  const hour=Math.floor(Date.now()/3600000);
  if(!hourBuckets.has(hour)){
    hourBuckets.set(hour,new Map());
  }
  const bucket=hourBuckets.get(hour);
  const bin=binSize(price);
  const key=Math.round(price/bin)*bin;

  if(!bucket.has(key)){
    bucket.set(key,{price:key,vol:0,delta:0});
  }
  const c=bucket.get(key);
  c.vol+=qty;
  c.delta+=side==='buy'?qty:-qty;
}

/* ===============================
   STOP-ZONE EXTRACTION
================================ */
function finalizeHour(){
  if(hourBuckets.size<2) return;

  const hours=[...hourBuckets.keys()].sort();
  const prev=hourBuckets.get(hours[hours.length-2]);

  const clusters=[...prev.values()];
  if(clusters.length<5) return;

  const avgVol=avg(clusters.map(c=>c.vol));

  clusters
    .filter(c=>c.vol>avgVol*2) // ðŸ”´ ONLY BIG
    .forEach(c=>{
      if(c.delta>0){
        // BUY aggression failed â†’ SELL STOPS BELOW
        finalizedZones.sell.push({
          from:c.price-binSize(c.price)*2,
          to:c.price-binSize(c.price)
        });
      }else{
        // SELL aggression failed â†’ BUY STOPS ABOVE
        finalizedZones.buy.push({
          from:c.price+binSize(c.price),
          to:c.price+binSize(c.price)*2
        });
      }
    });

  hourBuckets.delete(hours[0]); // keep memory small
}

/* ===============================
   RENDER (STABLE, NO JUMPING)
================================ */
function render(){
  if(!lastPrice) return;
  document.getElementById('price').innerText=lastPrice.toFixed(2);

  const buys=finalizedZones.buy.filter(z=>z.from>lastPrice);
  const sells=finalizedZones.sell.filter(z=>z.to<lastPrice);

  document.getElementById('buyStops').innerHTML=
    buys.length?buys.slice(0,5).map(z=>`
      <div class="zone buyZone">
        ${z.from.toFixed(2)} â†’ ${z.to.toFixed(2)}
      </div>`).join(''):'â€”';

  document.getElementById('sellStops').innerHTML=
    sells.length?sells.slice(0,5).map(z=>`
      <div class="zone sellZone">
        ${z.from.toFixed(2)} â†’ ${z.to.toFixed(2)}
      </div>`).join(''):'â€”';
}

/* ===============================
   BINANCE CONNECTION
================================ */
async function loadSymbols(){
  const r=await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
  const d=await r.json();
  symbol.innerHTML=d.symbols
    .filter(s=>s.contractType==='PERPETUAL')
    .map(s=>`<option>${s.symbol}</option>`).join('');
}

connect.onclick=()=>{
  if(ws) ws.close();
  finalizedZones={buy:[],sell:[]};
  hourBuckets.clear();

  const sym=symbol.value.toLowerCase();
  ws=new WebSocket(`wss://fstream.binance.com/ws/${sym}@aggTrade`);

  ws.onopen=()=>status.innerText='Connected';

  ws.onmessage=e=>{
    const t=JSON.parse(e.data);
    const p=+t.p,q=+t.q,side=t.m?'sell':'buy';
    lastPrice=p;
    addTrade(p,q,side);
    finalizeHour();
    render();
  };

  ws.onclose=()=>status.innerText='Disconnected';
};

loadSymbols();
</script>
</body>
</html>
