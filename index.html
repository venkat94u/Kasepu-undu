<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Institutional Major Clusters</title>

<style>
:root{
  --bg:#071226;
  --card:#0f2030;
  --muted:#9fb0c8;
  --accent:#00d084;
  --sell:#ff7b7b;
  --text:#e6f0fb;
  --border:#152433;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,system-ui,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:1200px;margin:auto;padding:14px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-top:12px;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}
.title{font-size:20px;font-weight:600}
.subtitle{font-size:13px;color:var(--muted)}
select,button{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#071b2b;
  color:var(--text);
}
button{cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.level{
  padding:8px;
  border-radius:8px;
  background:rgba(255,255,255,0.02);
  margin-bottom:6px;
}
.stop{
  margin-top:4px;
  color:var(--sell);
  font-size:12px;
}
.progress{
  height:6px;
  background:#152433;
  border-radius:4px;
  overflow:hidden;
  margin-top:6px;
}
.progress > div{
  height:100%;
  width:0%;
  background:var(--accent);
  transition:width .2s linear;
}
</style>
</head>

<body>
<div class="wrap">

<!-- HEADER -->
<div class="header card">
  <div>
    <div class="title">Institutional Major Levels</div>
    <div class="subtitle">
      Non-repainting â€¢ Executed trades â€¢ 2-day clusters â€¢ Â±1000 range
    </div>
  </div>
  <div>
    <select id="symbol"></select>
    <button id="connectBtn">Connect</button>
    <span id="status" class="small">Disconnected</span>
  </div>
</div>

<!-- PRICE -->
<div class="card">
  <div class="small">Current Price</div>
  <div id="price" style="font-size:22px;font-weight:600">â€”</div>
</div>

<!-- MAJOR LEVELS -->
<div class="card">
  <div class="small">MAJOR INSTITUTIONAL LEVELS (Â±1000)</div>
  <div id="levels" style="margin-top:8px">Waitingâ€¦</div>
  <div class="progress"><div id="progressBar"></div></div>
</div>

</div>

<script>
/* ======================================================
   GLOBAL STATE
====================================================== */
let ws = null;
let running = false;
let lastPrice = null;
let clusterMap = new Map();

const RANGE_POINTS = 1000;

/* ======================================================
   BIN LOGIC
====================================================== */
function getBinSize(price){
  if(price >= 1000) return 100;
  return price * 0.005;
}

function addToCluster(price, qty, side){
  const binSize = getBinSize(price);
  const bin = Math.round(price / binSize) * binSize;

  if(!clusterMap.has(bin)){
    clusterMap.set(bin,{
      price:bin,
      totalVol:0,
      buyVol:0,
      sellVol:0
    });
  }
  const c = clusterMap.get(bin);
  c.totalVol += qty;
  side === 'buy' ? c.buyVol += qty : c.sellVol += qty;
}

/* ======================================================
   MAJOR CLUSTER FILTER
====================================================== */
function getMajorClusters(price){
  const min = price - RANGE_POINTS;
  const max = price + RANGE_POINTS;

  const arr = [...clusterMap.values()]
    .filter(c => c.price >= min && c.price <= max);

  if(arr.length < 5) return [];

  const avg = arr.reduce((s,c)=>s+c.totalVol,0) / arr.length;

  return arr
    .filter(c => c.totalVol >= avg * 1.5)
    .sort((a,b)=>b.totalVol - a.totalVol)
    .slice(0,6);
}

function sellerStopZone(c){
  if(c.sellVol > c.buyVol * 1.6){
    const buf = c.price >= 1000 ? 150 : c.price * 0.01;
    return {from:c.price+buf,to:c.price+buf*1.5};
  }
  return null;
}

/* ======================================================
   UI RENDER
====================================================== */
function render(){
  if(!lastPrice) return;

  document.getElementById('price').innerText = lastPrice.toFixed(2);
  const el = document.getElementById('levels');

  const majors = getMajorClusters(lastPrice);
  if(majors.length === 0){
    el.innerHTML = '<span class="small">Building clustersâ€¦</span>';
    return;
  }

  el.innerHTML = majors.map(c=>{
    const sl = sellerStopZone(c);
    return `
      <div class="level">
        <b>${c.price.toFixed(2)}</b>
        â€” Vol ${c.totalVol.toFixed(0)}
        ${sl ? `<div class="stop">
          Seller SL: ${sl.from.toFixed(2)} â€“ ${sl.to.toFixed(2)}
        </div>` : ``}
      </div>`;
  }).join('');
}

/* ======================================================
   ðŸ”¥ 2-DAY HISTORICAL PRELOAD (PAGINATED)
====================================================== */
async function preloadHistoricalTrades(symbol, days = 2){
  clusterMap.clear();
  const endTime = Date.now();
  const startLimit = endTime - days*24*60*60*1000;

  let fromId = null;
  let loaded = 0;

  const bar = document.getElementById('progressBar');
  bar.style.width = '0%';

  while(true){
    let url =
      `https://fapi.binance.com/fapi/v1/aggTrades?symbol=${symbol}&limit=1000`;
    if(fromId !== null) url += `&fromId=${fromId}`;

    const res = await fetch(url);
    const data = await res.json();
    if(!Array.isArray(data) || data.length === 0) break;

    for(const t of data){
      if(t.T < startLimit) return;
      const price = parseFloat(t.p);
      const qty   = parseFloat(t.q);
      const side  = t.m ? 'sell' : 'buy';
      addToCluster(price, qty, side);
      lastPrice = price;
      loaded++;
    }

    fromId = data[0].a - 1;

    if(loaded % 5000 === 0){
      bar.style.width = Math.min(90, loaded/2000) + '%';
      await new Promise(r => setTimeout(r, 15));
    }
  }
}

/* ======================================================
   SYMBOL LOADER (ALL COINS)
====================================================== */
async function loadSymbols(){
  const sel = document.getElementById('symbol');
  sel.innerHTML = '<option>Loadingâ€¦</option>';

  const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
  const data = await res.json();

  const list = data.symbols
    .filter(s=>s.contractType==='PERPETUAL' && s.symbol.endsWith('USDT'))
    .map(s=>s.symbol)
    .sort();

  sel.innerHTML = list.map(s=>`<option>${s}</option>`).join('');
  sel.value = list.includes('BTCUSDT') ? 'BTCUSDT' : list[0];
}

/* ======================================================
   CONNECT
====================================================== */
document.getElementById('connectBtn').onclick = async ()=>{
  if(running) return;

  const symbol = document.getElementById('symbol').value;
  document.getElementById('status').innerText = 'Loading 2 daysâ€¦';

  await preloadHistoricalTrades(symbol, 2);
  render();

  ws = new WebSocket(
    `wss://fstream.binance.com/ws/${symbol.toLowerCase()}@aggTrade`
  );

  ws.onopen = ()=>{
    running = true;
    document.getElementById('status').innerText = 'Connected';
    document.getElementById('progressBar').style.width = '100%';
  };

  ws.onmessage = e=>{
    const t = JSON.parse(e.data);
    const price = parseFloat(t.p);
    const qty   = parseFloat(t.q);
    const side  = t.m ? 'sell' : 'buy';
    lastPrice = price;
    addToCluster(price, qty, side);
    render();
  };

  ws.onclose = ()=>{
    running = false;
    document.getElementById('status').innerText = 'Disconnected';
  };
};

/* ======================================================
   INIT
====================================================== */
loadSymbols();
</script>
</body>
</html>
